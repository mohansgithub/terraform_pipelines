pipeline {
    agent any

    tools {
        git 'git'
        jdk 'JDK17'
    }

    environment {
        // The SonarQube environment name configured in Jenkins
        SONARQUBE_ENV = 'SonarQubeServer'
        // The project key registered in SonarQube
        SONAR_PROJECT_KEY = 'terraform_sonar'
        SONAR_HOST_URL = 'http://localhost:9000'
        SONAR_AUTH_TOKEN = credentials('Sonarqube_Jenkins')
    }

    stages {

        stage('Checkout') {
            steps {
                git 'https://github.com/mohansgithub/terraform_pipelines.git'
            }
        }

        stage('SonarQube Analysis') {
            steps {
                script {
                    echo "üîç Starting SonarQube analysis for Terraform..."

                    // Use the SonarQube environment configured in Jenkins
                    withSonarQubeEnv("${SONARQUBE_ENV}") {
                        // Fetch the scanner path from Jenkins tool configuration
                        def scannerHome = tool 'sonar-scanner-cli'

                        // Run SonarQube analysis (Windows version)
                        bat """
                            "${scannerHome}\\bin\\sonar-scanner.bat" ^
                              -D"sonar.projectKey=${SONAR_PROJECT_KEY}" ^
                              -D"sonar.projectName=Terraform Pipeline Scan" ^
                              -D"sonar.sources=." ^
                              -D"sonar.host.url=${SONAR_HOST_URL}" ^
                              -D"sonar.login=${SONAR_AUTH_TOKEN}" ^
                              -D"sonar.language=terraform" ^
                              -D"sonar.terraform.file.suffixes=.tf"
                        """
                    }
                }
            }
        }

    }

    post {
        success {
            echo '‚úÖ SonarQube analysis completed successfully and passed Quality Gate!'
        }
        failure {
            echo '‚ùå Build failed or Quality Gate not passed!'
        }
    }
}
